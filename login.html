<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - CloudLock Password Manager</title>

  <!-- External Dependencies -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Custom Styles -->
  <link rel="stylesheet" href="styles/main.css?v=3" />
  <link rel="stylesheet" href="styles/animations.css?v=3" />
  <link rel="stylesheet" href="styles/components.css?v=5" />
  <link rel="stylesheet" href="styles/landing.css?v=1" />

  <style>
    /* Security Questions Styling */
    .security-questions {
      margin-top: 30px;
      padding: 25px;
      background: rgba(124, 58, 237, 0.05);
      border: 1px solid rgba(124, 58, 237, 0.2);
      border-radius: 15px;
    }

    .security-questions h3 {
      margin-bottom: 8px;
      font-size: 1.2rem;
      color: #a78bfa;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .security-questions-description {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .security-question-item {
      margin-bottom: 20px;
    }

    .security-question-item:last-child {
      margin-bottom: 0;
    }

    .security-question-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .security-question-label i {
      color: #a78bfa;
      font-size: 0.9rem;
    }

    .security-question-select {
      width: 100%;
      padding: 12px 15px;
      background: rgba(15, 15, 35, 0.8);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-radius: 10px;
      color: #fff;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a78bfa' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 35px;
      margin-bottom: 10px;
    }

    .security-question-select:hover {
      border-color: rgba(124, 58, 237, 0.5);
      background-color: rgba(15, 15, 35, 0.9);
    }

    .security-question-select:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }

    .security-question-select option {
      background: #1a1a2e;
      color: #fff;
      padding: 10px;
    }

    .security-question-input {
      width: 100%;
      padding: 12px 15px;
      background: rgba(15, 15, 35, 0.8);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-radius: 10px;
      color: #fff;
      font-size: 0.95rem;
      transition: all 0.3s;
    }

    .security-question-input:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
      background: rgba(15, 15, 35, 0.9);
    }

    .security-question-input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    /* Question number badge */
    .question-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="bg-animation">
    <div class="floating-orb" style="width: 200px; height: 200px; top: 10%; left: 10%;"></div>
    <div class="floating-orb" style="width: 150px; height: 150px; top: 70%; left: 80%; animation-delay: -7s;"></div>
    <div class="floating-orb" style="width: 100px; height: 100px; top: 40%; left: 50%; animation-delay: -14s;"></div>
  </div>

  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <div class="logo">
        <i class="fas fa-shield-alt"></i>
        <span>CloudLock</span>
      </div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="index.html#features">Features</a>
        <a href="index.html#security">Security</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div id="auth-container" class="auth-container" style="margin-top: 100px;">
      <div class="auth-tabs">
        <button class="tab-btn active" onclick="switchTab('login')">Login</button>
        <button class="tab-btn" onclick="switchTab('register')">Register</button>
      </div>

      <!-- Login Form -->
      <div id="login-form" class="auth-form">
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" required placeholder="Enter your email" />
          </div>
          <div class="form-group">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" required placeholder="Enter your password" />
          </div>
          <div class="form-group">
            <label for="login-2fa">2FA Code (if enabled)</label>
            <input type="text" id="login-2fa" placeholder="Enter 6-digit code" />
          </div>
          <button type="submit" class="btn btn-full">
            <i class="fas fa-lock"></i>
            Secure Login
          </button>
          <div class="auth-footer">
            Forgot password? <a href="#reset">Reset here</a>
          </div>
        </form>
      </div>

      <!-- Register Form -->
      <div id="register-form" class="auth-form" style="display: none;">
        <form onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="reg-name">Full Name</label>
            <input type="text" id="reg-name" required placeholder="Enter your full name" />
          </div>
          <div class="form-group">
            <label for="reg-email">Email</label>
            <input type="email" id="reg-email" required placeholder="Enter your email" />
          </div>
          <div class="form-group">
            <label for="reg-password">Master Password</label>
            <input type="password" id="reg-password" required placeholder="Create a strong password" />

            <div class="strength-bar-container">
              <div class="strength-bar" id="strengthBar"></div>
            </div>
            <div class="strength-text" id="strengthText"></div>

            <div class="password-requirements">
              <div class="requirements-title">Password Requirements</div>
              <div class="requirement-item" data-requirement="length"><div class="requirement-icon"><i class="fas fa-check"></i></div><div class="requirement-text">At least 8 characters</div></div>
              <div class="requirement-item" data-requirement="uppercase"><div class="requirement-icon"><i class="fas fa-check"></i></div><div class="requirement-text">One uppercase letter (A-Z)</div></div>
              <div class="requirement-item" data-requirement="lowercase"><div class="requirement-icon"><i class="fas fa-check"></i></div><div class="requirement-text">One lowercase letter (a-z)</div></div>
              <div class="requirement-item" data-requirement="number"><div class="requirement-icon"><i class="fas fa-check"></i></div><div class="requirement-text">One number (0-9)</div></div>
              <div class="requirement-item" data-requirement="special"><div class="requirement-icon"><i class="fas fa-check"></i></div><div class="requirement-text">One special character (!@#$%^&*)</div></div>
            </div>
          </div>
          <div class="form-group">
            <label for="reg-confirm">Confirm Password</label>
            <input type="password" id="reg-confirm" required placeholder="Confirm your password" />
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="enable-2fa" style="width: auto; margin-right: 10px;" />Enable Two-Factor Authentication</label>
          </div>

          <!-- Beautiful Security Questions -->
          <div class="security-questions">
            <h3>
              <i class="fas fa-shield-alt"></i>
              Security Questions
            </h3>
            <p class="security-questions-description">
              Choose 3 security questions to help you recover your account if you forget your password.
            </p>

            <!-- Question 1 -->
            <div class="security-question-item">
              <div class="security-question-label">
                <span class="question-number">1</span>
                <span>First Security Question</span>
              </div>
              <select id="question1-select" class="security-question-select" required>
                <option value="">-- Select a question --</option>
                <option value="pet">What was the name of your first pet?</option>
                <option value="city">In what city were you born?</option>
                <option value="school">What is the name of your elementary school?</option>
                <option value="car">What was the make of your first car?</option>
                <option value="food">What is your favorite food?</option>
                <option value="teacher">What was your favorite teacher's name?</option>
              </select>
              <input type="text" id="question1" class="security-question-input" required placeholder="Your answer..." />
            </div>

            <!-- Question 2 -->
            <div class="security-question-item">
              <div class="security-question-label">
                <span class="question-number">2</span>
                <span>Second Security Question</span>
              </div>
              <select id="question2-select" class="security-question-select" required>
                <option value="">-- Select a question --</option>
                <option value="maiden">What is your mother's maiden name?</option>
                <option value="street">What street did you grow up on?</option>
                <option value="job">What was your first job?</option>
                <option value="movie">What is your favorite movie?</option>
                <option value="book">What is your favorite book?</option>
                <option value="vacation">Where did you go on your first vacation?</option>
              </select>
              <input type="text" id="question2" class="security-question-input" required placeholder="Your answer..." />
            </div>

            <!-- Question 3 -->
            <div class="security-question-item">
              <div class="security-question-label">
                <span class="question-number">3</span>
                <span>Third Security Question</span>
              </div>
              <select id="question3-select" class="security-question-select" required>
                <option value="">-- Select a question --</option>
                <option value="nickname">What was your childhood nickname?</option>
                <option value="friend">What is your best friend's name?</option>
                <option value="sport">What is your favorite sport?</option>
                <option value="sibling">What is your oldest sibling's name?</option>
                <option value="color">What is your favorite color?</option>
                <option value="hospital">In what hospital were you born?</option>
              </select>
              <input type="text" id="question3" class="security-question-input" required placeholder="Your answer..." />
            </div>
          </div>

          <button type="submit" class="btn btn-full" id="registerSubmitBtn" style="margin-top: 25px;">
            <i class="fas fa-user-plus"></i>
            Create Secure Account
          </button>
          <div class="auth-footer">
            Already have an account? <a href="#" onclick="switchTab('login'); return false;">Login here</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- CryptoJS for Encryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <!-- Application Scripts -->
  <script src="js/config.js"></script>
  <script src="js/firebase-init.js"></script>
  <script src="js/ui-utils.js"></script>
  <script src="js/encryption.js"></script>
  <script src="js/interactive-background.js"></script>

  <!-- Auth Logic -->
  <script>
    let encryptionKey = null;

    const requirements = {
      length: password => password.length >= 8,
      uppercase: password => /[A-Z]/.test(password),
      lowercase: password => /[a-z]/.test(password),
      number: password => /[0-9]/.test(password),
      special: password => /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };

    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('reg-password');
      const confirmPasswordInput = document.getElementById('reg-confirm');
      if (passwordInput) passwordInput.addEventListener('input', updatePasswordStrength);
      if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', updateSubmitButton);
      firebase.auth().onAuthStateChanged(user => { if (user) window.location.href = 'dashboard.html'; });
    });

    function updatePasswordStrength() {
      const password = document.getElementById('reg-password').value;
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');
      let metCount = 0;

      Object.keys(requirements).forEach(req => {
        const item = document.querySelector(`[data-requirement="${req}"]`);
        if (!item) return;
        const isMet = requirements[req](password);
        item.classList.toggle('met', isMet);
        item.classList.toggle('active', password.length > 0);
        if (isMet) metCount++;
      });

      if (strengthBar && strengthText) {
        strengthBar.className = 'strength-bar';
        if (metCount === 0) {
          strengthBar.style.width = '0%';
          strengthText.textContent = '';
          strengthText.style.color = '';
        } else if (metCount <= 2) {
          strengthBar.classList.add('weak');
          strengthText.textContent = 'Weak';
          strengthText.style.color = '#ef4444';
        } else if (metCount === 3) {
          strengthBar.classList.add('fair');
          strengthText.textContent = 'Fair';
          strengthText.style.color = '#f59e0b';
        } else if (metCount === 4) {
          strengthBar.classList.add('good');
          strengthText.textContent = 'Good';
          strengthText.style.color = '#a78bfa';
        } else if (metCount === 5) {
          strengthBar.classList.add('strong');
          strengthText.textContent = 'Strong';
          strengthText.style.color = '#10b981';
        }
      }
      updateSubmitButton();
    }

    function updateSubmitButton() {
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm').value;
      const btn = document.getElementById('registerSubmitBtn');
      const allMet = Object.keys(requirements).every(req => requirements[req](password));
      const match = password === confirmPassword && password.length > 0;
      
      // Enable button if all requirements met and passwords match
      if (allMet && match) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.style.pointerEvents = 'auto';
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        btn.style.pointerEvents = 'none';
      }
    }

    function switchTab(tab) {
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(btn => btn.classList.remove('active'));
      if (tab === 'login') { 
        loginForm.style.display = 'block'; 
        registerForm.style.display = 'none'; 
        tabs[0].classList.add('active'); 
      } else { 
        loginForm.style.display = 'none'; 
        registerForm.style.display = 'block'; 
        tabs[1].classList.add('active'); 
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      
      const name = document.getElementById('reg-name').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm').value;
      const enable2FA = document.getElementById('enable-2fa').checked;

      // Get security questions
      const question1Select = document.getElementById('question1-select').value;
      const question1Answer = document.getElementById('question1').value;
      const question2Select = document.getElementById('question2-select').value;
      const question2Answer = document.getElementById('question2').value;
      const question3Select = document.getElementById('question3-select').value;
      const question3Answer = document.getElementById('question3').value;

      // Validate security questions
      if (!question1Select || !question2Select || !question3Select) {
        showToast('Please select all security questions', 'error');
        return;
      }

      if (!question1Answer || !question2Answer || !question3Answer) {
        showToast('Please answer all security questions', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showToast('Passwords do not match!', 'error');
        return;
      }

      const allMet = Object.keys(requirements).every(req => requirements[req](password));
      if (!allMet) {
        showToast('Please meet all password requirements', 'error');
        return;
      }

      const btn = event.target.querySelector('button[type="submit"]');
      const originalHTML = btn.innerHTML;
      
      try {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
        btn.disabled = true;

        // Create authentication account
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        encryptionKey = password;

        // Store user data in Firestore with security questions
        await firebase.firestore().collection('users').doc(userCredential.user.uid).set({
          name: name,
          email: email,
          twoFactorEnabled: enable2FA,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          securityQuestions: {
            question1: {
              question: question1Select,
              answer: CryptoJS.SHA256(question1Answer.toLowerCase().trim()).toString()
            },
            question2: {
              question: question2Select,
              answer: CryptoJS.SHA256(question2Answer.toLowerCase().trim()).toString()
            },
            question3: {
              question: question3Select,
              answer: CryptoJS.SHA256(question3Answer.toLowerCase().trim()).toString()
            }
          }
        });

        showToast('Account created successfully!', 'success');
        setTimeout(() => { window.location.href = 'dashboard.html'; }, 1000);
        
      } catch (error) {
        console.error('Registration error details:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        
        let msg = 'Registration failed. Please try again.';
        if (error.code === 'auth/email-already-in-use') {
          msg = 'This email is already registered.';
        } else if (error.code === 'auth/invalid-email') {
          msg = 'Invalid email address.';
        } else if (error.code === 'auth/weak-password') {
          msg = 'Password is too weak.';
        } else if (error.code === 'permission-denied') {
          msg = 'Database permission error. Please check Firestore rules.';
        }
        
        showToast(msg, 'error');
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      const btn = event.target.querySelector('button[type="submit"]');
      const originalHTML = btn.innerHTML;
      
      try {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        btn.disabled = true;
        
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        encryptionKey = password;
        
        showToast('Login successful!', 'success');
        setTimeout(() => window.location.href = 'dashboard.html', 1000);
      } catch (error) {
        let msg = 'Login failed. Please check your credentials.';
        if (error.code === 'auth/user-not-found') msg = 'No account found.';
        else if (error.code === 'auth/wrong-password') msg = 'Incorrect password.';
        else if (error.code === 'auth/invalid-email') msg = 'Invalid email.';
        
        showToast(msg, 'error');
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>