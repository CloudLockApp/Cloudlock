<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CloudLock</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles/main.css?v=3">
    <link rel="stylesheet" href="styles/animations.css?v=3">
    <link rel="stylesheet" href="styles/components.css?v=5">
    <link rel="stylesheet" href="styles/security-insights.css">
    <link rel="stylesheet" href="styles/audit-log.css">

    <style>
        .dashboard-header h1::after {
            content: "|";
            animation: blink 1s infinite;
            opacity: 1;
            margin-left: 4px;
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0; }
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(124, 58, 237, 0.2);
            padding-bottom: 0;
        }

        .settings-tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            bottom: -2px;
        }

        .settings-tab-btn:hover {
            color: #a78bfa;
        }

        .settings-tab-btn.active {
            color: #fff;
            border-bottom-color: #7c3aed;
        }

        .settings-tab-btn i {
            font-size: 1rem;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h4 {
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .toggle-switch input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 13px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
            background: #7c3aed;
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        .toggle-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }

        /* Improved Select Dropdown */
        .settings-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(15, 15, 35, 0.8);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a78bfa' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

        .settings-select:hover {
            border-color: rgba(124, 58, 237, 0.5);
            background: rgba(15, 15, 35, 0.9);
        }

        .settings-select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .settings-select option {
            background: #1a1a2e;
            color: #fff;
            padding: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .settings-tab-btn {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation">
        <div class="floating-orb" style="width: 200px; height: 200px; top: 10%; left: 10%;"></div>
        <div class="floating-orb" style="width: 150px; height: 150px; top: 70%; left: 80%; animation-delay: -7s;"></div>
        <div class="floating-orb" style="width: 100px; height: 100px; top: 40%; left: 50%; animation-delay: -14s;"></div>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>CloudLock</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <!-- Settings Button -->
                <button class="icon-btn" onclick="openSettings()" title="Settings" style="width: 40px; height: 40px;">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="dashboard" class="dashboard active">
            <div class="dashboard-header">
                <h1></h1>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="user-email">user@example.com</span>
                </div>
            </div>

            <!-- Security Status Cards -->
            <div class="security-status">
                <div class="status-card">
                    <h3><i class="fas fa-shield-alt"></i> Zero-Trust Status</h3>
                    <div class="status-indicator status-active">
                        <i class="fas fa-check-circle"></i> Active Protection
                    </div>
                    <p style="margin-top: 10px; opacity: 0.8;">All systems verified</p>
                </div>

                <div class="status-card">
                    <h3><i class="fas fa-lock"></i> Encryption</h3>
                    <div class="status-indicator status-active">
                        <i class="fas fa-check-circle"></i> AES-256 + RSA-4096
                    </div>
                    <p style="margin-top: 10px; opacity: 0.8;">Military-grade encryption active</p>
                </div>

                <div class="status-card">
                    <h3><i class="fas fa-cloud"></i> Multi-Cloud Backup</h3>
                    <div class="status-indicator status-active">
                        <i class="fas fa-check-circle"></i> 3 Clouds Synced
                    </div>
                    <p style="margin-top: 10px; opacity: 0.8;">AWS, Google Cloud, Azure</p>
                </div>

                <div class="status-card">
                    <h3><i class="fas fa-globe"></i> Dark Web Monitor</h3>
                    <div id="dark-web-status" class="status-indicator status-active">
                        <i class="fas fa-check-circle"></i> No Breaches Detected
                    </div>
                    <p style="margin-top: 10px; opacity: 0.8;">Last scan: Just now</p>
                </div>
            </div>

            <!-- Password Vault Controls -->
            <div class="vault-controls">
                <div class="search-box">
                    <input type="text" id="search-passwords" placeholder="Search passwords..." onkeyup="searchPasswords()">
                </div>
                <button class="btn" onclick="openAddPasswordModal()">
                    <i class="fas fa-plus"></i>
                    Add Password
                </button>
                <button class="btn btn-success" onclick="generateSecurePassword()">
                    <i class="fas fa-key"></i>
                    Generate Password
                </button>
            </div>

            <div id="password-list" class="password-grid"></div>
            <div id="insight-messages" style="margin-top: 20px;"></div>

            <!-- Self Destruct Panel -->
            <div class="self-destruct-panel">
                <h3><i class="fas fa-bomb"></i> Emergency Self-Destruct</h3>
                <p>In case of emergency, instantly wipe all credentials across all devices and cloud storage.</p>
                <button class="btn btn-danger" onclick="confirmSelfDestruct()">
                    <i class="fas fa-exclamation-triangle"></i>
                    Activate Self-Destruct
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Password Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Password</h2>
                <button class="close-btn" onclick="closeModal('password-modal')">&times;</button>
            </div>
            <form onsubmit="savePassword(event)">
                <div class="form-group">
                    <label for="site-name">Website/Service Name</label>
                    <input type="text" id="site-name" required placeholder="e.g., Google, Facebook">
                </div>
                <div class="form-group">
                    <label for="site-url">URL</label>
                    <input type="url" id="site-url" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="site-username">Username/Email</label>
                    <input type="text" id="site-username" required placeholder="Your username or email">
                </div>
                <div class="form-group">
                    <label for="site-password">Password</label>
                    <input type="password" id="site-password" required placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label for="site-notes">Notes (Optional)</label>
                    <textarea id="site-notes" rows="3" placeholder="Additional secure notes"></textarea>
                </div>
                <input type="hidden" id="password-id">
                <button type="submit" class="btn btn-full">
                    <i class="fas fa-save"></i>
                    Save Encrypted
                </button>
                <div class="ai-chat-notice">
                    <small>By submitting, you are agreeing to have the password's metadata analyzed by AI to determine its strength. The password will be stored securely and will not be sent to AI.</small>
                </div>

            </form>
        </div>
    </div>

    <!-- Advanced Password Generator Modal -->
    <div id="password-generator-modal" class="modal">
        <div class="modal-content generator-modal">
            <div class="modal-header">
                <h2><i class="fas fa-key"></i> Advanced Password Generator</h2>
                <button class="close-btn" onclick="closeModal('password-generator-modal')">&times;</button>
            </div>

            <div class="generator-preview-section">
                <div class="generator-preview" id="generator-preview">Loading...</div>
                <div class="generator-strength" id="generator-strength">
                    <i class="fas fa-shield-alt"></i> Strong
                </div>
                <div class="generator-actions">
                    <button class="btn" onclick="updateGeneratorPreview()">
                        <i class="fas fa-sync-alt"></i> Regenerate
                    </button>
                    <button class="btn btn-success" onclick="copyGeneratedPassword()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="btn" onclick="useGeneratedPassword()" style="background: var(--primary);">
                        <i class="fas fa-check"></i> Use This Password
                    </button>
                </div>
            </div>

            <div class="generator-types">
                <h3>Password Type</h3>
                <div class="type-options">
                    <label class="type-option">
                        <input type="radio" name="password-type" value="strong" checked onchange="updateGeneratorPreview()">
                        <div class="option-card"><i class="fas fa-shield-alt"></i><strong>Strong Random</strong><span>Maximum security</span></div>
                    </label>
                    <label class="type-option">
                        <input type="radio" name="password-type" value="memorable" onchange="updateGeneratorPreview()">
                        <div class="option-card"><i class="fas fa-brain"></i><strong>Memorable</strong><span>Easy to remember</span></div>
                    </label>
                    <label class="type-option">
                        <input type="radio" name="password-type" value="passphrase" onchange="updateGeneratorPreview()">
                        <div class="option-card"><i class="fas fa-quote-left"></i><strong>Passphrase</strong><span>Word-based</span></div>
                    </label>
                    <label class="type-option">
                        <input type="radio" name="password-type" value="pin" onchange="updateGeneratorPreview()">
                        <div class="option-card"><i class="fas fa-hashtag"></i><strong>PIN Code</strong><span>Numbers only</span></div>
                    </label>
                </div>
            </div>

            <div class="generator-settings">
                <h3>Customize</h3>
                <div class="setting-group">
                    <label>
                        <span>Length: <strong id="length-value">16</strong></span>
                        <input type="range" min="8" max="32" value="16" 
                               oninput="document.getElementById('length-value').textContent = this.value; updateGeneratorSetting('length', parseInt(this.value))">
                    </label>
                </div>

                <div class="setting-group checkboxes">
                    <label><input type="checkbox" checked onchange="updateGeneratorSetting('uppercase', this.checked)"> <span>Uppercase (A-Z)</span></label>
                    <label><input type="checkbox" checked onchange="updateGeneratorSetting('lowercase', this.checked)"> <span>Lowercase (a-z)</span></label>
                    <label><input type="checkbox" checked onchange="updateGeneratorSetting('numbers', this.checked)"> <span>Numbers (0-9)</span></label>
                    <label><input type="checkbox" checked onchange="updateGeneratorSetting('symbols', this.checked)"> <span>Symbols (!@#$)</span></label>
                </div>

                <div class="setting-group checkboxes">
                    <label><input type="checkbox" onchange="updateGeneratorSetting('excludeSimilar', this.checked)"> <span>Exclude similar characters</span></label>
                    <label><input type="checkbox" onchange="updateGeneratorSetting('excludeAmbiguous', this.checked)"> <span>Exclude ambiguous symbols</span></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="close-btn" onclick="closeModal('settings-modal')">&times;</button>
            </div>

            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab-btn active" onclick="switchSettingsTab('profile')">
                    <i class="fas fa-user"></i> Profile
                </button>
                <button class="settings-tab-btn" onclick="switchSettingsTab('security')">
                    <i class="fas fa-shield-alt"></i> Security
                </button>
                <button class="settings-tab-btn" onclick="switchSettingsTab('activity')">
                    <i class="fas fa-history"></i> Activity Log
                </button>
                <button class="settings-tab-btn" onclick="switchSettingsTab('preferences')">
                    <i class="fas fa-sliders-h"></i> Preferences
                </button>
            </div>

            <!-- Profile Tab -->
            <div id="settings-profile" class="settings-tab-content active">
                <h3 style="margin-bottom: 20px; color: #a78bfa;">Profile Information</h3>
                
                <div class="form-group">
                    <label for="settings-name">Full Name</label>
                    <input type="text" id="settings-name" placeholder="Your full name">
                </div>

                <div class="form-group">
                    <label for="settings-email">Email Address</label>
                    <input type="email" id="settings-email" placeholder="your.email@example.com">
                    <small style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 5px; display: block;">
                        Used for login and security notifications
                    </small>
                </div>

                <div class="form-group">
                    <label>Account Created</label>
                    <div style="padding: 12px; background: rgba(15, 15, 35, 0.6); border-radius: 8px; color: rgba(255,255,255,0.7);">
                        <span id="account-created-date">Loading...</span>
                    </div>
                </div>

                <button class="btn btn-full" onclick="saveProfileSettings()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>

            <!-- Security Tab -->
            <div id="settings-security" class="settings-tab-content">
                <h3 style="margin-bottom: 20px; color: #a78bfa;">Security Settings</h3>

                <div class="settings-section">
                    <h4><i class="fas fa-key"></i> Change Master Password</h4>
                    <p style="opacity: 0.7; margin-bottom: 15px;">Update your master password. This will re-encrypt all your passwords.</p>
                    
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" placeholder="Enter current password">
                    </div>

                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" placeholder="Enter new password">
                    </div>

                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" placeholder="Confirm new password">
                    </div>

                    <button class="btn" onclick="changeMasterPassword()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(124, 58, 237, 0.2); margin: 30px 0;">

                <div class="settings-section">
                    <h4><i class="fas fa-shield-alt"></i> Two-Factor Authentication</h4>
                    <p style="opacity: 0.7; margin-bottom: 15px;">Add an extra layer of security to your account.</p>
                    
                    <label class="toggle-switch">
                        <input type="checkbox" id="2fa-toggle" onchange="toggle2FA(this.checked)">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Enable Two-Factor Authentication</span>
                    </label>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(124, 58, 237, 0.2); margin: 30px 0;">

                <div class="settings-section">
                    <h4><i class="fas fa-clock"></i> Session Timeout</h4>
                    <p style="opacity: 0.7; margin-bottom: 15px;">Auto-logout after period of inactivity.</p>
                    
                    <select id="session-timeout" class="settings-select">
                        <option value="15">15 minutes</option>
                        <option value="30" selected>30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="120">2 hours</option>
                        <option value="never">Never</option>
                    </select>
                </div>
            </div>

            <!-- Activity Log Tab -->
            <div id="settings-activity" class="settings-tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #a78bfa; margin: 0;">Activity Log</h3>
                    <button class="btn" onclick="refreshActivityLog()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Security Notice -->
                <div class="audit-security-notice" style="margin-bottom: 20px;">
                    <i class="fas fa-shield-alt"></i>
                    <div class="audit-security-notice-content">
                        <div class="audit-security-notice-title">ðŸ”’ Privacy Protected</div>
                        <div class="audit-security-notice-text">
                            All events are encrypted end-to-end. Previous passwords are stored as hashes only. 
                            This log is tamper-proof and cannot be edited.
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 0.9rem; opacity: 0.9;">Filter by Action</label>
                        <select id="audit-filter-action" onchange="filterGlobalAudit()" class="settings-select">
                            <option value="all">All Actions</option>
                            <option value="PASSWORD_CREATED">Created</option>
                            <option value="PASSWORD_CHANGED">Changed</option>
                            <option value="PASSWORD_VIEWED">Viewed</option>
                            <option value="PASSWORD_DELETED">Deleted</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 0.9rem; opacity: 0.9;">Filter by Password</label>
                        <select id="audit-filter-password" onchange="filterGlobalAudit()" class="settings-select">
                            <option value="all">All Passwords</option>
                        </select>
                    </div>
                </div>

                <!-- Activity Log Content -->
                <div id="global-audit-content" style="max-height: 500px; overflow-y: auto;">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Preferences Tab -->
            <div id="settings-preferences" class="settings-tab-content">
                <h3 style="margin-bottom: 20px; color: #a78bfa;">Preferences</h3>

                <div class="settings-section">
                    <h4><i class="fas fa-palette"></i> Appearance</h4>
                    <p style="opacity: 0.7; margin-bottom: 15px;">Customize the look and feel of CloudLock.</p>
                    
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle" checked disabled>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Dark Mode (Always On)</span>
                    </label>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(124, 58, 237, 0.2); margin: 30px 0;">

                <div class="settings-section">
                    <h4><i class="fas fa-bell"></i> Notifications</h4>
                    <p style="opacity: 0.7; margin-bottom: 15px;">Manage notification preferences.</p>
                    
                    <label class="toggle-switch">
                        <input type="checkbox" id="breach-alerts" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Dark Web Breach Alerts</span>
                    </label>

                    <label class="toggle-switch">
                        <input type="checkbox" id="weak-password-alerts" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Weak Password Warnings</span>
                    </label>

                    <label class="toggle-switch">
                        <input type="checkbox" id="login-alerts">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">New Device Login Alerts</span>
                    </label>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(124, 58, 237, 0.2); margin: 30px 0;">

                <div class="settings-section">
                    <h4><i class="fas fa-download"></i> Export Data</h4>
                    <p style="opacity: 0.7; margin-bottom: 15px;">Download all your passwords as an encrypted backup.</p>
                    
                    <button class="btn" onclick="exportPasswords()">
                        <i class="fas fa-file-export"></i> Export Passwords (Encrypted)
                    </button>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(124, 58, 237, 0.2); margin: 30px 0;">

                <div class="settings-section">
                    <h4 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h4>
                    <p style="opacity: 0.7; margin-bottom: 15px;">Permanently delete your account and all data.</p>
                    
                    <button class="btn btn-danger" onclick="deleteAccount()">
                        <i class="fas fa-trash"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Chat -->
    <div class="ai-assistant">
        <div id="ai-chat" class="ai-chat">
            <div class="ai-chat-header">
                <h3><i class="fas fa-robot"></i> AI Security Assistant</h3>
            </div>
            <div id="ai-messages" class="ai-chat-messages">
                <div class="ai-message bot">
                    Hello! I'm your AI security assistant. I can help you with password security.
                </div>
            </div>
            <div class="ai-chat-input">
                <input type="text" id="ai-input" placeholder="Ask me anything..." onkeypress="handleAIChat(event)">
                <button class="btn" onclick="sendAIMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="ai-chat-notice">
                <small>By chatting, you are agreeing to send your messages to OpenRouter and Mistral AI. Please do not put any sensitive information, such as passwords.</small>
            </div>
        </div>
        <button class="ai-toggle" onclick="toggleAIChat()">
            <i class="fas fa-robot"></i>
        </button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- App Scripts - ORDER MATTERS -->
    <script src="js/config.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/encryption.js"></script>
    <script src="js/security-monitor.js"></script>
    <script src="js/audit-log.js"></script>
    <script src="js/password-manager.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/advanced-generator.js"></script>
    <script src="js/security-insights.js"></script>
    <script src="js/interactive-background.js"></script>

    <script>
        let encryptionKey = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-email').textContent = user.email;
                    const dashboardTitle = document.querySelector('.dashboard-header h1');
                    dashboardTitle.textContent = '';

                    function typeWriter(element, text, speed = 60) {
                        let i = 0;
                        element.textContent = '';
                        function typing() {
                            if (i < text.length) {
                                element.textContent += text.charAt(i);
                                i++;
                                setTimeout(typing, speed);
                            }
                        }
                        typing();
                    }

                    try {
                        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                        if (userDoc.exists && userDoc.data().name) {
                            const userName = userDoc.data().name;
                            const welcomeMessages = [
                                'Welcome back, ' + userName + '.',
                                'Identity verified. Welcome, ' + userName + '.',
                                'You\'re in, ' + userName + '. Let\'s keep your world secure.'
                            ];
                            const message = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                            typeWriter(dashboardTitle, message, 60);
                        } else {
                            typeWriter(dashboardTitle, 'Access granted. Your vault is secure.', 60);
                        }
                    } catch (error) {
                        console.error('Error fetching user data:', error);
                        typeWriter(dashboardTitle, 'Welcome to Your Secure Vault.', 60);
                    }

                    loadPasswords();
                } else {
                    window.location.href = 'login.html';
                }
            });
        });

        async function logout() {
            try {
                await firebase.auth().signOut();
                encryptionKey = null;
                showToast('Logged out successfully', 'success');
                setTimeout(function() {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Logout failed', 'error');
            }
        }

        // Settings Functions
        function openSettings() {
            openModal('settings-modal');
            loadProfileSettings();
            switchSettingsTab('profile');
        }

        function switchSettingsTab(tab) {
            document.querySelectorAll('.settings-tab-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            
            var buttons = document.querySelectorAll('.settings-tab-btn');
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i].getAttribute('onclick').indexOf(tab) !== -1) {
                    buttons[i].classList.add('active');
                }
            }
            
            document.getElementById('settings-' + tab).classList.add('active');
            
            if (tab === 'activity') {
                loadGlobalAuditLog();
            }
        }

        async function loadProfileSettings() {
            if (!firebase.auth().currentUser) return;
            
            var user = firebase.auth().currentUser;
            
            document.getElementById('settings-email').value = user.email;
            
            try {
                var userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    var userData = userDoc.data();
                    document.getElementById('settings-name').value = userData.name || '';
                    
                    if (userData.createdAt) {
                        var date = userData.createdAt.toDate();
                        document.getElementById('account-created-date').textContent = date.toLocaleDateString('en-US', { 
                            month: 'long', 
                            day: 'numeric', 
                            year: 'numeric' 
                        });
                    }
                    
                    document.getElementById('2fa-toggle').checked = userData.twoFactorEnabled || false;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function saveProfileSettings() {
            if (!firebase.auth().currentUser) return;
            
            var name = document.getElementById('settings-name').value;
            var user = firebase.auth().currentUser;
            
            try {
                await firebase.firestore().collection('users').doc(user.uid).update({
                    name: name
                });
                
                showToast('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Error saving profile:', error);
                showToast('Failed to update profile', 'error');
            }
        }

        function changeMasterPassword() {
            var currentPassword = document.getElementById('current-password').value;
            var newPassword = document.getElementById('new-password').value;
            var confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all password fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }
            
            showToast('Password change feature coming soon!', 'warning');
        }

        async function toggle2FA(enabled) {
            if (!firebase.auth().currentUser) return;
            
            try {
                await firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid).update({
                    twoFactorEnabled: enabled
                });
                
                showToast(enabled ? '2FA enabled' : '2FA disabled', 'success');
            } catch (error) {
                console.error('Error toggling 2FA:', error);
                showToast('Failed to update 2FA settings', 'error');
            }
        }

        function refreshActivityLog() {
            loadGlobalAuditLog();
            showToast('Activity log refreshed', 'success');
        }

        function exportPasswords() {
            showToast('Export feature coming soon!', 'warning');
        }

        function deleteAccount() {
            var confirmed = confirm('âš ï¸ WARNING âš ï¸\n\nThis will PERMANENTLY delete your account and ALL passwords!\n\nThis action CANNOT be undone!\n\nType "DELETE" in the next prompt to confirm.');
            
            if (confirmed) {
                var finalConfirm = prompt('Type DELETE to confirm account deletion:');
                if (finalConfirm === 'DELETE') {
                    showToast('Account deletion feature coming soon', 'warning');
                }
            }
        }
    </script>
</body>
</html>